# ============================================================
# File: docker-compose.prod.yml
# Purpose: Production Docker environment for KeiroGenesis REST API
# ============================================================

version: '3.9'

services:
  # ============================================================
  # KeiroGenesis API (.NET 8 backend)
  # ============================================================
  keirogenesis-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: keirogenesis-api-prod
    ports:
      - "8080:8080"   # Changed from 5000:8080 to 8080:8080
    environment:
      # =====================================================
      # üß© ASP.NET Core Configuration
      # =====================================================
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://0.0.0.0:8080"

      # =====================================================
      # üß† Database Configuration (Google Cloud SQL Server)
      # =====================================================
      DatabaseSettings__Host: "34.48.221.124"
      DatabaseSettings__Port: "1433"
      DatabaseSettings__Database: "kg-prod-db"
      DatabaseSettings__Username: "app_keiro"
      DatabaseSettings__Password: "ProdStrongPassword!"
      DatabaseSettings__Encrypt: "true"
      DatabaseSettings__TrustServerCertificate: "false"

      # =====================================================
      # üß± Caching / Messaging (Production Redis)
      # =====================================================
      ConnectionStrings__Redis: "prod-redis.example.com:6379"

      # =====================================================
      # üîê Authentication Settings
      # =====================================================
      Auth__Issuer: "KeiroGenesis"
      Auth__Audience: "KeiroGenesisClients"
      Auth__AccessTokenMinutes: "15"
      Auth__RefreshTokenDays: "7"

      # =====================================================
      # üåê Frontend Integration (Production)
      # =====================================================
      ApplicationOptions__DashboardBaseUrl: "https://dashboard.keiroclone.com"

      # =====================================================
      # üß≠ CORS (Allow Production React frontends)
      # =====================================================
      AllowedOrigins__0: "https://keiroclone.com"
      AllowedOrigins__1: "https://www.keiroclone.com"
      AllowedOrigins__2: "https://dashboard.keiroclone.com"

      # =====================================================
      # üßæ Logging (Serilog)
      # =====================================================
      Serilog__MinimumLevel__Default: "Information"
      Serilog__MinimumLevel__Override__Microsoft: "Warning"
      Serilog__MinimumLevel__Override__System: "Warning"

    networks:
      - keirogenesis-network
    restart: unless-stopped

    # =====================================================
    # ü©∫ Health Check Endpoint
    # =====================================================
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Persist ASP.NET data protection keys
    volumes:
      - dataprotection_keys:/root/.aspnet/DataProtection-Keys

# ============================================================
# Network and Volume Definitions
# ============================================================
networks:
  keirogenesis-network:
    driver: bridge

volumes:
  dataprotection_keys:
